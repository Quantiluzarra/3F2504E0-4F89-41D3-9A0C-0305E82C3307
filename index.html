<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTICOLOR SQUARE - Professional Drawing Application</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-color: #667eea;
            --border-color: #e1e8ed;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-heavy: rgba(0, 0, 0, 0.2);
        }

        body.dark-theme {
            --primary-bg: #1a1d23;
            --secondary-bg: #23262d;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border-color: #3a3d44;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Animated Background */
        #animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0.15;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: float linear infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.6;
            }
            25% {
                transform: translate(30px, -30px) scale(1.1);
                opacity: 0.8;
            }
            50% {
                transform: translate(-20px, -60px) scale(0.9);
                opacity: 0.5;
            }
            75% {
                transform: translate(-40px, -30px) scale(1.05);
                opacity: 0.7;
            }
        }

        /* Main Container */
        #app-container {
            position: relative;
            z-index: 1;
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Header */
        #app-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px var(--shadow-light);
            z-index: 100;
        }

        #app-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-square {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 8px;
            animation: logo-pulse 3s ease-in-out infinite;
        }

        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #app-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        /* Left Toolbar */
        #left-toolbar {
            position: absolute;
            left: 0;
            top: 70px;
            bottom: 0;
            width: 80px;
            background: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 15px;
            box-shadow: 2px 0 10px var(--shadow-light);
            z-index: 99;
            overflow-y: auto;
        }

        .tool-btn {
            width: 50px;
            height: 50px;
            background: var(--primary-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tool-btn i {
            font-size: 20px;
            color: var(--text-primary);
        }

        .tool-btn:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: scale(1.1);
        }

        .tool-btn:hover i {
            color: white;
        }

        .tool-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .tool-btn.active i {
            color: white;
        }

        .tooltip {
            position: absolute;
            left: 70px;
            background: var(--text-primary);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tool-btn:hover .tooltip {
            opacity: 1;
        }

        /* Settings Panel */
        #settings-panel {
            position: absolute;
            left: 80px;
            top: 70px;
            width: 300px;
            background: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 2px 0 10px var(--shadow-light);
            z-index: 98;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }

        .value-display {
            min-width: 40px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Color Picker */
        .color-picker-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        input[type="color"] {
            width: 0;
            height: 0;
            opacity: 0;
            position: absolute;
        }

        /* Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .palette-color {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .palette-color:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .palette-color.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Canvas Size Presets */
        .canvas-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preset-btn {
            padding: 8px 12px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .preset-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        .canvas-size-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .canvas-size-inputs input {
            padding: 6px 8px;
            font-size: 13px;
        }

        /* Canvas Area */
        #canvas-container {
            position: absolute;
            left: 380px;
            top: 70px;
            right: 0;
            bottom: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-bg);
            overflow: auto;
        }

        #canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 40px var(--shadow-heavy);
            border-radius: 4px;
        }

        #main-canvas {
            display: block;
            background: white;
            cursor: crosshair;
        }

        #preview-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* Layers Panel */
        #layers-panel {
            position: fixed;
            right: -320px;
            top: 70px;
            width: 300px;
            height: calc(100vh - 150px);
            background: var(--secondary-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px var(--shadow-light);
            z-index: 99;
            overflow-y: auto;
        }

        #layers-panel.open {
            right: 0;
        }

        .layer-item {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: var(--border-color);
            transform: translateX(-5px);
        }

        .layer-item.active {
            border-color: var(--accent-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .layer-preview {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        .layer-info {
            flex: 1;
        }

        .layer-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .layer-controls {
            display: flex;
            gap: 8px;
        }

        .layer-control-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .layer-control-btn:hover {
            color: var(--accent-color);
            transform: scale(1.2);
        }

        /* Bottom Bar */
        #bottom-bar {
            position: absolute;
            bottom: 0;
            left: 380px;
            right: 0;
            height: 80px;
            background: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0 30px;
            box-shadow: 0 -2px 10px var(--shadow-light);
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }

        .zoom-display {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
        }

        /* Action Buttons */
        .action-btn {
            padding: 10px 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .action-btn.secondary {
            background: var(--primary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #settings-panel {
                width: 250px;
            }
            #canvas-container {
                left: 330px;
            }
            #bottom-bar {
                left: 330px;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div id="animated-background"></div>

    <!-- Main App Container -->
    <div id="app-container">
        <!-- Header -->
        <header id="app-header">
            <div id="app-logo">
                <div class="logo-square"></div>
                <h1 id="app-title">MULTICOLOR SQUARE</h1>
            </div>
            <div id="header-actions">
                <button class="header-btn" id="canvas-size-btn">
                    <i class="fas fa-expand"></i> Размер холста
                </button>
                <button class="header-btn" id="new-project-btn">
                    <i class="fas fa-file"></i> Новый
                </button>
                <button class="header-btn" id="open-btn">
                    <i class="fas fa-folder-open"></i> Открыть
                </button>
                <button class="header-btn" id="save-btn">
                    <i class="fas fa-save"></i> Сохранить
                </button>
                <button class="header-btn" id="export-btn">
                    <i class="fas fa-download"></i> Экспорт
                </button>
                <button class="header-btn" id="layers-toggle-btn">
                    <i class="fas fa-layer-group"></i> Слои
                </button>
                <button class="header-btn" id="theme-toggle-btn">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <!-- Left Toolbar -->
        <div id="left-toolbar">
            <div class="tool-btn active" data-tool="brush">
                <i class="fas fa-paintbrush"></i>
                <span class="tooltip">Кисть (B)</span>
            </div>
            <div class="tool-btn" data-tool="eraser">
                <i class="fas fa-eraser"></i>
                <span class="tooltip">Ластик (E)</span>
            </div>
            <div class="tool-btn" data-tool="fill">
                <i class="fas fa-fill-drip"></i>
                <span class="tooltip">Заливка (G)</span>
            </div>
            <div class="tool-btn" data-tool="picker">
                <i class="fas fa-eye-dropper"></i>
                <span class="tooltip">Пипетка (I)</span>
            </div>
            <div class="tool-btn" data-tool="line">
                <i class="fas fa-minus"></i>
                <span class="tooltip">Линия (L)</span>
            </div>
            <div class="tool-btn" data-tool="rectangle">
                <i class="fas fa-square"></i>
                <span class="tooltip">Прямоугольник (R)</span>
            </div>
            <div class="tool-btn" data-tool="circle">
                <i class="fas fa-circle"></i>
                <span class="tooltip">Круг (C)</span>
            </div>
            <div class="tool-btn" data-tool="triangle">
                <i class="fas fa-play"></i>
                <span class="tooltip">Треугольник (T)</span>
            </div>
            <div class="tool-btn" data-tool="text">
                <i class="fas fa-font"></i>
                <span class="tooltip">Текст (A)</span>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel">
            <!-- Brush Size -->
            <div class="settings-group">
                <label class="settings-label">Размер кисти</label>
                <div class="settings-control">
                    <input type="range" class="slider" id="brush-size" min="1" max="50" value="5">
                    <span class="value-display" id="brush-size-value">5px</span>
                </div>
            </div>

            <!-- Opacity -->
            <div class="settings-group">
                <label class="settings-label">Прозрачность</label>
                <div class="settings-control">
                    <input type="range" class="slider" id="opacity" min="0" max="100" value="100">
                    <span class="value-display" id="opacity-value">100%</span>
                </div>
            </div>

            <!-- Hardness -->
            <div class="settings-group">
                <label class="settings-label">Твердость</label>
                <div class="settings-control">
                    <input type="range" class="slider" id="hardness" min="0" max="100" value="100">
                    <span class="value-display" id="hardness-value">100%</span>
                </div>
            </div>

            <!-- Blend Mode -->
            <div class="settings-group">
                <label class="settings-label">Режим наложения</label>
                <select id="blend-mode">
                    <option value="source-over">Normal</option>
                    <option value="multiply">Multiply</option>
                    <option value="screen">Screen</option>
                    <option value="overlay">Overlay</option>
                    <option value="darken">Darken</option>
                    <option value="lighten">Lighten</option>
                </select>
            </div>

            <!-- Brush Texture -->
            <div class="settings-group">
                <label class="settings-label">Текстура кисти</label>
                <select id="brush-texture">
                    <option value="smooth">Гладкая</option>
                    <option value="watercolor">Акварельная</option>
                    <option value="pencil">Карандашная</option>
                </select>
            </div>

            <!-- Color Picker -->
            <div class="settings-group">
                <label class="settings-label">Основной цвет</label>
                <div class="color-picker-container">
                    <div class="color-swatch" id="primary-color-swatch" style="background: #000000;"></div>
                    <input type="color" id="primary-color" value="#000000">
                    <div class="color-swatch" id="secondary-color-swatch" style="background: #ffffff;"></div>
                    <input type="color" id="secondary-color" value="#ffffff">
                </div>
            </div>

            <!-- Color Palette -->
            <div class="settings-group">
                <label class="settings-label">Палитра цветов</label>
                <div class="color-palette" id="color-palette"></div>
            </div>

            <!-- Font Settings (for text tool) -->
            <div class="settings-group" id="text-settings" style="display: none;">
                <label class="settings-label">Настройки текста</label>
                <select id="font-family">
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                </select>
                <div class="settings-control" style="margin-top: 10px;">
                    <input type="range" class="slider" id="font-size" min="12" max="72" value="24">
                    <span class="value-display" id="font-size-value">24px</span>
                </div>
            </div>
        </div>

        <!-- Canvas Container -->
        <div id="canvas-container">
            <div id="canvas-wrapper">
                <canvas id="main-canvas" width="800" height="600"></canvas>
                <canvas id="preview-canvas" width="800" height="600"></canvas>
            </div>
        </div>

        <!-- Layers Panel -->
        <div id="layers-panel">
            <h3 style="margin-bottom: 15px;">Слои</h3>
            <button class="action-btn" id="add-layer-btn" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-plus"></i> Новый слой
            </button>
            <div id="layers-list"></div>
        </div>

        <!-- Bottom Bar -->
        <div id="bottom-bar">
            <button class="action-btn secondary" id="undo-btn">
                <i class="fas fa-undo"></i> Отменить
            </button>
            <button class="action-btn secondary" id="redo-btn">
                <i class="fas fa-redo"></i> Вернуть
            </button>
            
            <div class="zoom-control">
                <button class="zoom-btn" id="zoom-out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span class="zoom-display" id="zoom-display">100%</span>
                <button class="zoom-btn" id="zoom-in">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>

            <button class="action-btn secondary" id="flip-h-btn">
                <i class="fas fa-arrows-alt-h"></i> Отразить
            </button>
            <button class="action-btn secondary" id="rotate-btn">
                <i class="fas fa-sync-alt"></i> Повернуть
            </button>
            <button class="action-btn secondary" id="clear-btn">
                <i class="fas fa-trash"></i> Очистить
            </button>
        </div>
    </div>

    <!-- Canvas Size Modal -->
    <div class="modal" id="canvas-size-modal">
        <div class="modal-content">
            <div class="modal-header">Изменить размер холста</div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Готовые пресеты</label>
                    <div class="canvas-presets">
                        <button class="preset-btn" data-width="800" data-height="600">800 x 600</button>
                        <button class="preset-btn" data-width="1024" data-height="768">1024 x 768</button>
                        <button class="preset-btn" data-width="1280" data-height="720">1280 x 720 (HD)</button>
                        <button class="preset-btn" data-width="1920" data-height="1080">1920 x 1080 (FHD)</button>
                        <button class="preset-btn" data-width="1080" data-height="1080">1080 x 1080 (1:1)</button>
                        <button class="preset-btn" data-width="1080" data-height="1350">1080 x 1350 (4:5)</button>
                        <button class="preset-btn" data-width="2560" data-height="1440">2560 x 1440 (2K)</button>
                        <button class="preset-btn" data-width="3840" data-height="2160">3840 x 2160 (4K)</button>
                        <button class="preset-btn" data-width="500" data-height="500">500 x 500</button>
                        <button class="preset-btn" data-width="600" data-height="400">600 x 400</button>
                        <button class="preset-btn" data-width="1200" data-height="628">1200 x 628 (FB)</button>
                        <button class="preset-btn" data-width="1500" data-height="500">1500 x 500 (Twitter)</button>
                    </div>
                </div>
                
                <div class="settings-group" style="margin-top: 20px;">
                    <label class="settings-label">Пользовательский размер</label>
                    <div class="canvas-size-inputs">
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Ширина</label>
                            <input type="number" id="custom-width" min="1" max="4000" value="800">
                        </div>
                        <span style="font-weight: bold;">×</span>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Высота</label>
                            <input type="number" id="custom-height" min="1" max="4000" value="600">
                        </div>
                    </div>
                </div>

                <div class="settings-group" style="margin-top: 20px;">
                    <label class="settings-label">Сохранить содержимое</label>
                    <select id="resize-mode">
                        <option value="scale">Масштабировать содержимое</option>
                        <option value="crop">Обрезать содержимое</option>
                        <option value="clear">Очистить холст</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="canvas-size-cancel-btn">Отмена</button>
                <button class="action-btn" id="canvas-size-confirm-btn">
                    <i class="fas fa-check"></i> Применить
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">Экспорт изображения</div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Формат файла</label>
                    <select id="export-format">
                        <option value="png">PNG</option>
                        <option value="jpeg">JPEG</option>
                        <option value="webp">WebP</option>
                    </select>
                </div>
                <div class="settings-group" style="margin-top: 15px;">
                    <label class="settings-label">Качество (для JPEG/WebP)</label>
                    <div class="settings-control">
                        <input type="range" class="slider" id="export-quality" min="0" max="100" value="90">
                        <span class="value-display" id="export-quality-value">90%</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="export-cancel-btn">Отмена</button>
                <button class="action-btn" id="export-confirm-btn">
                    <i class="fas fa-download"></i> Скачать
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // APP STATE & INITIALIZATION
        // ===========================================
        
        const app = {
            canvas: document.getElementById('main-canvas'),
            previewCanvas: document.getElementById('preview-canvas'),
            ctx: null,
            previewCtx: null,
            currentTool: 'brush',
            isDrawing: false,
            brushSize: 5,
            opacity: 100,
            hardness: 100,
            blendMode: 'source-over',
            brushTexture: 'smooth',
            primaryColor: '#000000',
            secondaryColor: '#ffffff',
            fontFamily: 'Arial',
            fontSize: 24,
            zoom: 1,
            layers: [],
            currentLayer: 0,
            history: [],
            historyStep: -1,
            maxHistory: 50,
            startX: 0,
            startY: 0,
            lastX: 0,
            lastY: 0,
            isPreviewActive: false
        };

        app.ctx = app.canvas.getContext('2d');
        app.previewCtx = app.previewCanvas.getContext('2d');

        // ===========================================
        // ANIMATED BACKGROUND
        // ===========================================
        
        function createAnimatedBackground() {
            const bg = document.getElementById('animated-background');
            const particleCount = 30;
            
            const colors = [
                'rgba(102, 126, 234, 0.3)',
                'rgba(118, 75, 162, 0.3)',
                'rgba(240, 147, 251, 0.3)',
                'rgba(100, 200, 250, 0.3)',
                'rgba(150, 100, 250, 0.3)',
                'rgba(255, 180, 200, 0.3)'
            ];

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 100 + 50;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDuration = (Math.random() * 20 + 15) + 's';
                particle.style.animationDelay = (Math.random() * 5) + 's';
                
                bg.appendChild(particle);
            }
        }

        // Parallax effect
        document.addEventListener('mousemove', (e) => {
            const particles = document.querySelectorAll('.particle');
            const mouseX = e.clientX / window.innerWidth;
            const mouseY = e.clientY / window.innerHeight;
            
            particles.forEach((particle, index) => {
                const speed = (index + 1) * 0.02;
                const x = (mouseX - 0.5) * 50 * speed;
                const y = (mouseY - 0.5) * 50 * speed;
                particle.style.transform = `translate(${x}px, ${y}px)`;
            });
        });

        // ===========================================
        // COLOR PALETTE
        // ===========================================
        
        const colorPalette = [
            '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
            '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#008000', '#FFC0CB',
            '#808080', '#A52A2A', '#FFD700', '#4B0082', '#FF1493', '#00CED1',
            '#8B4513', '#2F4F4F', '#DC143C', '#4169E1', '#32CD32', '#FF69B4'
        ];

        function initColorPalette() {
            const palette = document.getElementById('color-palette');
            colorPalette.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'palette-color';
                colorDiv.style.background = color;
                colorDiv.addEventListener('click', () => {
                    app.primaryColor = color;
                    document.getElementById('primary-color').value = color;
                    document.getElementById('primary-color-swatch').style.background = color;
                    document.querySelectorAll('.palette-color').forEach(el => el.classList.remove('active'));
                    colorDiv.classList.add('active');
                });
                palette.appendChild(colorDiv);
            });
        }

        // ===========================================
        // CANVAS SIZE MANAGEMENT
        // ===========================================
        
        function resizeCanvas(width, height, mode = 'scale') {
            const oldCanvas = document.createElement('canvas');
            oldCanvas.width = app.canvas.width;
            oldCanvas.height = app.canvas.height;
            const oldCtx = oldCanvas.getContext('2d');
            
            // Save all layers
            const oldLayers = app.layers.map(layer => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = layer.canvas.width;
                tempCanvas.height = layer.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(layer.canvas, 0, 0);
                return tempCanvas;
            });

            // Resize main canvas
            app.canvas.width = width;
            app.canvas.height = height;
            app.previewCanvas.width = width;
            app.previewCanvas.height = height;

            // Resize all layers
            app.layers.forEach((layer, index) => {
                layer.canvas.width = width;
                layer.canvas.height = height;
                const ctx = layer.canvas.getContext('2d');
                
                if (mode === 'scale') {
                    ctx.drawImage(oldLayers[index], 0, 0, width, height);
                } else if (mode === 'crop') {
                    ctx.drawImage(oldLayers[index], 0, 0);
                } else if (mode === 'clear') {
                    if (index === 0) {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, width, height);
                    }
                }
            });

            renderLayers();
            saveHistory();
        }

        function setupCanvasSizeModal() {
            const modal = document.getElementById('canvas-size-modal');
            const openBtn = document.getElementById('canvas-size-btn');
            const cancelBtn = document.getElementById('canvas-size-cancel-btn');
            const confirmBtn = document.getElementById('canvas-size-confirm-btn');
            const customWidth = document.getElementById('custom-width');
            const customHeight = document.getElementById('custom-height');

            openBtn.addEventListener('click', () => {
                customWidth.value = app.canvas.width;
                customHeight.value = app.canvas.height;
                modal.classList.add('active');
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('active');
            });

            confirmBtn.addEventListener('click', () => {
                const width = parseInt(customWidth.value);
                const height = parseInt(customHeight.value);
                const mode = document.getElementById('resize-mode').value;

                if (width > 0 && height > 0 && width <= 4000 && height <= 4000) {
                    resizeCanvas(width, height, mode);
                    modal.classList.remove('active');
                } else {
                    alert('Размеры должны быть от 1 до 4000 пикселей');
                }
            });

            // Preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const width = parseInt(btn.dataset.width);
                    const height = parseInt(btn.dataset.height);
                    customWidth.value = width;
                    customHeight.value = height;
                });
            });
        }

        // ===========================================
        // LAYERS SYSTEM
        // ===========================================
        
        function initLayers() {
            app.layers.push({
                name: 'Фон',
                canvas: createOffscreenCanvas(),
                visible: true,
                locked: false,
                opacity: 100
            });
            app.currentLayer = 0;
            updateLayersPanel();
            renderLayers();
        }

        function createOffscreenCanvas() {
            const offCanvas = document.createElement('canvas');
            offCanvas.width = app.canvas.width;
            offCanvas.height = app.canvas.height;
            const ctx = offCanvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, offCanvas.width, offCanvas.height);
            return offCanvas;
        }

        function addLayer() {
            const newLayer = {
                name: `Слой ${app.layers.length}`,
                canvas: createOffscreenCanvas(),
                visible: true,
                locked: false,
                opacity: 100
            };
            const ctx = newLayer.canvas.getContext('2d');
            ctx.clearRect(0, 0, newLayer.canvas.width, newLayer.canvas.height);
            app.layers.push(newLayer);
            app.currentLayer = app.layers.length - 1;
            updateLayersPanel();
            saveHistory();
        }

        function updateLayersPanel() {
            const layersList = document.getElementById('layers-list');
            layersList.innerHTML = '';
            
            [...app.layers].reverse().forEach((layer, index) => {
                const actualIndex = app.layers.length - 1 - index;
                const layerDiv = document.createElement('div');
                layerDiv.className = 'layer-item' + (actualIndex === app.currentLayer ? ' active' : '');
                
                layerDiv.innerHTML = `
                    <canvas class="layer-preview" width="40" height="40"></canvas>
                    <div class="layer-info">
                        <div class="layer-name">${layer.name}</div>
                    </div>
                    <div class="layer-controls">
                        <button class="layer-control-btn" data-action="visible">
                            <i class="fas fa-eye${layer.visible ? '' : '-slash'}"></i>
                        </button>
                        <button class="layer-control-btn" data-action="lock">
                            <i class="fas fa-lock${layer.locked ? '' : '-open'}"></i>
                        </button>
                        <button class="layer-control-btn" data-action="delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                const preview = layerDiv.querySelector('.layer-preview');
                const previewCtx = preview.getContext('2d');
                previewCtx.drawImage(layer.canvas, 0, 0, 40, 30);
                
                layerDiv.addEventListener('click', (e) => {
                    if (!e.target.closest('.layer-control-btn')) {
                        app.currentLayer = actualIndex;
                        updateLayersPanel();
                    }
                });
                
                layerDiv.querySelectorAll('.layer-control-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = btn.dataset.action;
                        
                        if (action === 'visible') {
                            layer.visible = !layer.visible;
                            renderLayers();
                            updateLayersPanel();
                        } else if (action === 'lock') {
                            layer.locked = !layer.locked;
                            updateLayersPanel();
                        } else if (action === 'delete' && app.layers.length > 1) {
                            app.layers.splice(actualIndex, 1);
                            app.currentLayer = Math.max(0, app.currentLayer - 1);
                            updateLayersPanel();
                            renderLayers();
                            saveHistory();
                        }
                    });
                });
                
                layersList.appendChild(layerDiv);
            });
        }

        function renderLayers() {
            app.ctx.clearRect(0, 0, app.canvas.width, app.canvas.height);
            app.layers.forEach(layer => {
                if (layer.visible) {
                    app.ctx.globalAlpha = layer.opacity / 100;
                    app.ctx.drawImage(layer.canvas, 0, 0);
                }
            });
            app.ctx.globalAlpha = 1;
        }

        function getCurrentLayerContext() {
            return app.layers[app.currentLayer].canvas.getContext('2d');
        }

        // ===========================================
        // HISTORY (UNDO/REDO)
        // ===========================================
        
        function saveHistory() {
            if (app.historyStep < app.history.length - 1) {
                app.history = app.history.slice(0, app.historyStep + 1);
            }
            
            const state = app.layers.map(layer => {
                const canvas = document.createElement('canvas');
                canvas.width = layer.canvas.width;
                canvas.height = layer.canvas.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(layer.canvas, 0, 0);
                return {
                    ...layer,
                    canvas: canvas
                };
            });
            
            app.history.push(state);
            
            if (app.history.length > app.maxHistory) {
                app.history.shift();
            } else {
                app.historyStep++;
            }
        }

        function undo() {
            if (app.historyStep > 0) {
                app.historyStep--;
                restoreHistory();
            }
        }

        function redo() {
            if (app.historyStep < app.history.length - 1) {
                app.historyStep++;
                restoreHistory();
            }
        }

        function restoreHistory() {
            const state = app.history[app.historyStep];
            app.layers = state.map(layer => {
                const canvas = document.createElement('canvas');
                canvas.width = layer.canvas.width;
                canvas.height = layer.canvas.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(layer.canvas, 0, 0);
                return {
                    ...layer,
                    canvas: canvas
                };
            });
            renderLayers();
            updateLayersPanel();
        }

        // ===========================================
        // PREVIEW SYSTEM FOR SHAPES
        // ===========================================
        
        function clearPreview() {
            app.previewCtx.clearRect(0, 0, app.previewCanvas.width, app.previewCanvas.height);
        }

        function drawShapePreview(startX, startY, endX, endY) {
            clearPreview();
            
            const ctx = app.previewCtx;
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 0.7;
            ctx.strokeStyle = app.primaryColor;
            ctx.fillStyle = 'transparent';
            ctx.lineWidth = app.brushSize;
            ctx.setLineDash([5, 5]);
            
            ctx.beginPath();
            
            if (app.currentTool === 'line') {
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            } else if (app.currentTool === 'rectangle') {
                ctx.strokeRect(startX, startY, endX - startX, endY - startY);
            } else if (app.currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                ctx.stroke();
            } else if (app.currentTool === 'triangle') {
                const centerX = (startX + endX) / 2;
                ctx.moveTo(centerX, startY);
                ctx.lineTo(endX, endY);
                ctx.lineTo(startX, endY);
                ctx.closePath();
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
        }

        // ===========================================
        // DRAWING TOOLS
        // ===========================================
        
        function setupDrawingTools() {
            const canvas = app.canvas;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            if (app.layers[app.currentLayer].locked) return;
            
            app.isDrawing = true;
            const rect = app.canvas.getBoundingClientRect();
            app.startX = (e.clientX - rect.left) / app.zoom;
            app.startY = (e.clientY - rect.top) / app.zoom;
            app.lastX = app.startX;
            app.lastY = app.startY;
            
            if (app.currentTool === 'picker') {
                pickColor(app.startX, app.startY);
                app.isDrawing = false;
            } else if (app.currentTool === 'fill') {
                floodFill(Math.floor(app.startX), Math.floor(app.startY));
                app.isDrawing = false;
                saveHistory();
            } else if (app.currentTool === 'brush' || app.currentTool === 'eraser') {
                drawBrush(app.startX, app.startY);
            }
        }

        function draw(e) {
            const rect = app.canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / app.zoom;
            const y = (e.clientY - rect.top) / app.zoom;
            
            if (!app.isDrawing) {
                // Show preview for shape tools even when not drawing
                if (['line', 'rectangle', 'circle', 'triangle'].includes(app.currentTool)) {
                    // Don't show preview if not drawing
                    return;
                }
                return;
            }
            
            if (app.layers[app.currentLayer].locked) return;
            
            if (app.currentTool === 'brush' || app.currentTool === 'eraser') {
                drawBrush(x, y);
                app.lastX = x;
                app.lastY = y;
            } else if (['line', 'rectangle', 'circle', 'triangle'].includes(app.currentTool)) {
                drawShapePreview(app.startX, app.startY, x, y);
            }
        }

        function stopDrawing(e) {
            if (!app.isDrawing) return;
            
            if (['line', 'rectangle', 'circle', 'triangle'].includes(app.currentTool)) {
                const rect = app.canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / app.zoom;
                const y = (e.clientY - rect.top) / app.zoom;
                clearPreview();
                drawShape(app.startX, app.startY, x, y);
            }
            
            app.isDrawing = false;
            renderLayers();
            saveHistory();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                             e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            app.canvas.dispatchEvent(mouseEvent);
        }

        function drawBrush(x, y) {
            const ctx = getCurrentLayerContext();
            ctx.globalCompositeOperation = app.currentTool === 'eraser' ? 'destination-out' : app.blendMode;
            ctx.globalAlpha = app.opacity / 100;
            
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = app.primaryColor;
            ctx.lineWidth = app.brushSize;
            
            if (app.hardness < 100) {
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, app.brushSize / 2);
                gradient.addColorStop(0, app.primaryColor);
                gradient.addColorStop(app.hardness / 100, app.primaryColor);
                gradient.addColorStop(1, 'transparent');
                ctx.strokeStyle = gradient;
            }
            
            ctx.beginPath();
            ctx.moveTo(app.lastX, app.lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            renderLayers();
        }

        function drawShape(startX, startY, endX, endY) {
            const ctx = getCurrentLayerContext();
            ctx.globalCompositeOperation = app.blendMode;
            ctx.globalAlpha = app.opacity / 100;
            ctx.strokeStyle = app.primaryColor;
            ctx.fillStyle = app.primaryColor;
            ctx.lineWidth = app.brushSize;
            
            ctx.beginPath();
            
            if (app.currentTool === 'line') {
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            } else if (app.currentTool === 'rectangle') {
                ctx.strokeRect(startX, startY, endX - startX, endY - startY);
            } else if (app.currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                ctx.stroke();
            } else if (app.currentTool === 'triangle') {
                const centerX = (startX + endX) / 2;
                ctx.moveTo(centerX, startY);
                ctx.lineTo(endX, endY);
                ctx.lineTo(startX, endY);
                ctx.closePath();
                ctx.stroke();
            }
        }

        function pickColor(x, y) {
            const imageData = app.ctx.getImageData(x, y, 1, 1);
            const [r, g, b] = imageData.data;
            const hex = '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
            app.primaryColor = hex;
            document.getElementById('primary-color').value = hex;
            document.getElementById('primary-color-swatch').style.background = hex;
        }

        function floodFill(startX, startY) {
            const ctx = getCurrentLayerContext();
            const imageData = ctx.getImageData(0, 0, app.canvas.width, app.canvas.height);
            const pixels = imageData.data;
            
            const startPos = (startY * app.canvas.width + startX) * 4;
            const startR = pixels[startPos];
            const startG = pixels[startPos + 1];
            const startB = pixels[startPos + 2];
            const startA = pixels[startPos + 3];
            
            const fillColor = hexToRgb(app.primaryColor);
            
            if (startR === fillColor.r && startG === fillColor.g && 
                startB === fillColor.b && startA === 255) {
                return;
            }
            
            const stack = [[startX, startY]];
            const visited = new Set();
            
            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = `${x},${y}`;
                
                if (visited.has(key)) continue;
                if (x < 0 || x >= app.canvas.width || y < 0 || y >= app.canvas.height) continue;
                
                const pos = (y * app.canvas.width + x) * 4;
                
                if (pixels[pos] !== startR || pixels[pos + 1] !== startG || 
                    pixels[pos + 2] !== startB || pixels[pos + 3] !== startA) {
                    continue;
                }
                
                visited.add(key);
                pixels[pos] = fillColor.r;
                pixels[pos + 1] = fillColor.g;
                pixels[pos + 2] = fillColor.b;
                pixels[pos + 3] = 255;
                
                stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }
            
            ctx.putImageData(imageData, 0, 0);
            renderLayers();
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        // ===========================================
        // UI CONTROLS
        // ===========================================
        
        function setupUIControls() {
            // Tool selection
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    app.currentTool = btn.dataset.tool;
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    clearPreview();
                    
                    // Show/hide text settings
                    document.getElementById('text-settings').style.display = 
                        app.currentTool === 'text' ? 'flex' : 'none';
                });
            });
            
            // Brush size
            const brushSize = document.getElementById('brush-size');
            const brushSizeValue = document.getElementById('brush-size-value');
            brushSize.addEventListener('input', () => {
                app.brushSize = parseInt(brushSize.value);
                brushSizeValue.textContent = app.brushSize + 'px';
            });
            
            // Opacity
            const opacity = document.getElementById('opacity');
            const opacityValue = document.getElementById('opacity-value');
            opacity.addEventListener('input', () => {
                app.opacity = parseInt(opacity.value);
                opacityValue.textContent = app.opacity + '%';
            });
            
            // Hardness
            const hardness = document.getElementById('hardness');
            const hardnessValue = document.getElementById('hardness-value');
            hardness.addEventListener('input', () => {
                app.hardness = parseInt(hardness.value);
                hardnessValue.textContent = app.hardness + '%';
            });
            
            // Blend mode
            document.getElementById('blend-mode').addEventListener('change', (e) => {
                app.blendMode = e.target.value;
            });
            
            // Brush texture
            document.getElementById('brush-texture').addEventListener('change', (e) => {
                app.brushTexture = e.target.value;
            });
            
            // Color pickers
            document.getElementById('primary-color-swatch').addEventListener('click', () => {
                document.getElementById('primary-color').click();
            });
            
            document.getElementById('primary-color').addEventListener('input', (e) => {
                app.primaryColor = e.target.value;
                document.getElementById('primary-color-swatch').style.background = e.target.value;
            });
            
            document.getElementById('secondary-color-swatch').addEventListener('click', () => {
                document.getElementById('secondary-color').click();
            });
            
            document.getElementById('secondary-color').addEventListener('input', (e) => {
                app.secondaryColor = e.target.value;
                document.getElementById('secondary-color-swatch').style.background = e.target.value;
            });
            
            // Font settings
            document.getElementById('font-family').addEventListener('change', (e) => {
                app.fontFamily = e.target.value;
            });
            
            const fontSize = document.getElementById('font-size');
            const fontSizeValue = document.getElementById('font-size-value');
            fontSize.addEventListener('input', () => {
                app.fontSize = parseInt(fontSize.value);
                fontSizeValue.textContent = app.fontSize + 'px';
            });
            
            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                app.zoom = Math.min(4, app.zoom + 0.25);
                updateZoom();
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                app.zoom = Math.max(0.25, app.zoom - 0.25);
                updateZoom();
            });
            
            // Action buttons
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('redo-btn').addEventListener('click', redo);
            
            document.getElementById('clear-btn').addEventListener('click', () => {
                if (confirm('Очистить текущий слой?')) {
                    const ctx = getCurrentLayerContext();
                    ctx.clearRect(0, 0, app.canvas.width, app.canvas.height);
                    renderLayers();
                    saveHistory();
                }
            });
            
            document.getElementById('flip-h-btn').addEventListener('click', () => {
                const ctx = getCurrentLayerContext();
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = app.canvas.width;
                tempCanvas.height = app.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(app.layers[app.currentLayer].canvas, 0, 0);
                
                ctx.clearRect(0, 0, app.canvas.width, app.canvas.height);
                ctx.scale(-1, 1);
                ctx.drawImage(tempCanvas, -app.canvas.width, 0);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                renderLayers();
                saveHistory();
            });
            
            document.getElementById('rotate-btn').addEventListener('click', () => {
                const ctx = getCurrentLayerContext();
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = app.canvas.width;
                tempCanvas.height = app.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(app.layers[app.currentLayer].canvas, 0, 0);
                
                ctx.clearRect(0, 0, app.canvas.width, app.canvas.height);
                ctx.translate(app.canvas.width / 2, app.canvas.height / 2);
                ctx.rotate(Math.PI / 2);
                ctx.drawImage(tempCanvas, -app.canvas.width / 2, -app.canvas.height / 2);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                renderLayers();
                saveHistory();
            });
            
            // Layers
            document.getElementById('add-layer-btn').addEventListener('click', addLayer);
            document.getElementById('layers-toggle-btn').addEventListener('click', () => {
                document.getElementById('layers-panel').classList.toggle('open');
            });
            
            // Theme toggle
            document.getElementById('theme-toggle-btn').addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                const icon = document.querySelector('#theme-toggle-btn i');
                icon.classList.toggle('fa-moon');
                icon.classList.toggle('fa-sun');
            });
            
            // File operations
            document.getElementById('new-project-btn').addEventListener('click', () => {
                if (confirm('Создать новый проект? Несохраненные изменения будут потеряны.')) {
                    location.reload();
                }
            });
            
            document.getElementById('save-btn').addEventListener('click', saveProject);
            document.getElementById('open-btn').addEventListener('click', openProject);
            document.getElementById('export-btn').addEventListener('click', () => {
                document.getElementById('export-modal').classList.add('active');
            });
            
            // Export modal
            const exportQuality = document.getElementById('export-quality');
            const exportQualityValue = document.getElementById('export-quality-value');
            exportQuality.addEventListener('input', () => {
                exportQualityValue.textContent = exportQuality.value + '%';
            });
            
            document.getElementById('export-cancel-btn').addEventListener('click', () => {
                document.getElementById('export-modal').classList.remove('active');
            });
            
            document.getElementById('export-confirm-btn').addEventListener('click', exportImage);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        undo();
                    } else if (e.key === 'y') {
                        e.preventDefault();
                        redo();
                    } else if (e.key === 's') {
                        e.preventDefault();
                        saveProject();
                    }
                } else {
                    const toolMap = {
                        'b': 'brush',
                        'e': 'eraser',
                        'g': 'fill',
                        'i': 'picker',
                        'l': 'line',
                        'r': 'rectangle',
                        'c': 'circle',
                        't': 'triangle',
                        'a': 'text'
                    };
                    
                    if (toolMap[e.key.toLowerCase()]) {
                        const btn = document.querySelector(`[data-tool="${toolMap[e.key.toLowerCase()]}"]`);
                        if (btn) btn.click();
                    }
                }
            });
        }

        function updateZoom() {
            app.canvas.style.transform = `scale(${app.zoom})`;
            app.previewCanvas.style.transform = `scale(${app.zoom})`;
            document.getElementById('zoom-display').textContent = Math.round(app.zoom * 100) + '%';
        }

        // ===========================================
        // FILE OPERATIONS
        // ===========================================
        
        function saveProject() {
            const projectData = {
                layers: app.layers.map(layer => ({
                    name: layer.name,
                    visible: layer.visible,
                    locked: layer.locked,
                    opacity: layer.opacity,
                    data: layer.canvas.toDataURL()
                })),
                currentLayer: app.currentLayer,
                width: app.canvas.width,
                height: app.canvas.height
            };
            
            const json = JSON.stringify(projectData);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'multicolor-square-project.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function openProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const projectData = JSON.parse(event.target.result);
                    loadProject(projectData);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function loadProject(projectData) {
            app.canvas.width = projectData.width;
            app.canvas.height = projectData.height;
            app.previewCanvas.width = projectData.width;
            app.previewCanvas.height = projectData.height;
            app.currentLayer = projectData.currentLayer;
            
            app.layers = [];
            let loadedLayers = 0;
            
            projectData.layers.forEach((layerData, index) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = createOffscreenCanvas();
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    app.layers[index] = {
                        name: layerData.name,
                        canvas: canvas,
                        visible: layerData.visible,
                        locked: layerData.locked,
                        opacity: layerData.opacity
                    };
                    
                    loadedLayers++;
                    if (loadedLayers === projectData.layers.length) {
                        renderLayers();
                        updateLayersPanel();
                        saveHistory();
                    }
                };
                img.src = layerData.data;
            });
        }

        function exportImage() {
            const format = document.getElementById('export-format').value;
            const quality = parseInt(document.getElementById('export-quality').value) / 100;
            
            let mimeType = 'image/png';
            if (format === 'jpeg') mimeType = 'image/jpeg';
            else if (format === 'webp') mimeType = 'image/webp';
            
            const dataURL = app.canvas.toDataURL(mimeType, quality);
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `multicolor-square-artwork.${format}`;
            a.click();
            
            document.getElementById('export-modal').classList.remove('active');
        }

        // ===========================================
        // INITIALIZE APP
        // ===========================================
        
        function init() {
            createAnimatedBackground();
            initColorPalette();
            initLayers();
            setupDrawingTools();
            setupUIControls();
            setupCanvasSizeModal();
            saveHistory();
            
            // Auto-detect theme
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-theme');
                document.querySelector('#theme-toggle-btn i').classList.replace('fa-moon', 'fa-sun');
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
