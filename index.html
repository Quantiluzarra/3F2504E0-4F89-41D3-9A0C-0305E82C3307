<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>ШИФРОТЕКС</title>
  <style>
    :root{
      --tg-bg:#05070b;
      --tg-card:rgba(255,255,255,.06);
      --tg-text:#eef2ff;
      --tg-hint:rgba(226,232,255,.6);
      --tg-accent:#22d3a6;
      --tg-border:rgba(148, 163, 184,.3);

      --radius:16px;
      --radius-sm:12px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      --ui: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

      --safe-top:env(safe-area-inset-top,0px);
      --safe-bottom:env(safe-area-inset-bottom,0px);
      --safe-left:env(safe-area-inset-left,0px);
      --safe-right:env(safe-area-inset-right,0px);

      --anim:200ms;
      --anim-slow:420ms;
      --ease:cubic-bezier(.2,.8,.2,1);
    }

    @media (prefers-reduced-motion:reduce){
      :root{--anim:1ms;--anim-slow:1ms;}
      *{animation-duration:1ms!important;transition-duration:1ms!important;}
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--ui);
      color:var(--tg-text);
      background:#020617 radial-gradient(circle at 0 0,rgba(34,211,166,.16),transparent 55%);
      padding:
        calc(var(--safe-top)+10px)
        calc(var(--safe-right)+12px)
        calc(var(--safe-bottom)+12px)
        calc(var(--safe-left)+12px);
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      display:grid;
      gap:10px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--tg-border);
      background:rgba(15,23,42,.9);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      font-size:12px;
      animation:fadeUp var(--anim-slow) var(--ease);
    }
    .topbar span:first-child{
      font-weight:600;
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:11px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;margin-right:6px;
      background:var(--tg-accent);
      box-shadow:0 0 0 4px rgba(34,211,166,.18);
      animation:pulse 1.9s var(--ease) infinite;
      display:inline-block;
    }

    .tabs{
      display:flex;
      gap:6px;
      padding:4px;
      border-radius:999px;
      border:1px solid var(--tg-border);
      background:rgba(15,23,42,.9);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      font-size:11px;
      animation:fadeUp var(--anim-slow) var(--ease);
    }
    .tab{
      flex:1;
      border:0;
      border-radius:999px;
      padding:8px 10px;
      background:transparent;
      color:var(--tg-hint);
      text-transform:uppercase;
      letter-spacing:.7px;
      font-weight:600;
      cursor:pointer;
      transition:background var(--anim) var(--ease),color var(--anim) var(--ease),transform var(--anim) var(--ease);
    }
    .tab.active{
      background:var(--tg-accent);
      color:#020617;
      transform:translateY(-1px);
    }

    .section{display:none;}
    .section.active{display:block;animation:fadeUp var(--anim-slow) var(--ease);}

    .grid{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:10px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      border-radius:var(--radius);
      border:1px solid var(--tg-border);
      background:rgba(15,23,42,.92);
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-size:11px;
      letter-spacing:.8px;
      text-transform:uppercase;
      color:var(--tg-hint);
    }

    label{
      display:block;
      margin-bottom:4px;
      font-size:11px;
      color:var(--tg-hint);
      text-transform:uppercase;
      letter-spacing:.7px;
    }

    textarea,input,select{
      width:100%;
      border-radius:var(--radius-sm);
      border:1px solid rgba(148,163,184,.4);
      background:#020617;
      color:var(--tg-text);
      padding:10px 10px;
      font-size:13px;
      font-family:var(--mono);
      outline:none;
      transition:border-color var(--anim) var(--ease),box-shadow var(--anim) var(--ease),transform var(--anim) var(--ease);
    }
    textarea{min-height:110px;resize:vertical;}
    textarea:focus,input:focus,select:focus{
      border-color:var(--tg-accent);
      box-shadow:0 0 0 3px rgba(34,211,166,.18);
      transform:translateY(-1px);
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    @media (max-width:520px){
      .row{grid-template-columns:1fr;}
    }

    .switch{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--tg-hint);
      margin-top:4px;
    }
    .switch input{width:16px;height:16px;accent-color:var(--tg-accent);}

    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn{
      flex:1;
      border:0;
      border-radius:999px;
      padding:9px 10px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.7px;
      font-weight:700;
      cursor:pointer;
      background:var(--tg-accent);
      color:#020617;
      box-shadow:0 8px 22px rgba(34,211,166,.25);
      position:relative;
      overflow:hidden;
      transition:transform var(--anim) var(--ease),filter var(--anim) var(--ease);
      min-width:120px;
    }
    .btn.secondary{
      background:#020617;
      color:var(--tg-text);
      border:1px solid rgba(148,163,184,.5);
      box-shadow:none;
    }
    .btn:active{transform:translateY(0) scale(.97);}
    .btn:hover{transform:translateY(-1px);filter:saturate(1.05);}
    .ripple{
      position:absolute;
      border-radius:999px;
      background:rgba(255,255,255,.35);
      transform:scale(0);
      animation:ripple 480ms var(--ease);
      pointer-events:none;
      mix-blend-mode:overlay;
    }

    .out{
      border-radius:var(--radius-sm);
      border:1px solid rgba(148,163,184,.5);
      background:#020617;
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      min-height:90px;
      word-break:break-all;
      overflow:auto;
      position:relative;
    }
    .out.loading::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,transparent,rgba(248,250,252,.08),transparent);
      transform:translateX(-100%);
      animation:shimmer 900ms linear infinite;
      pointer-events:none;
    }

    .meta{
      font-size:11px;
      color:var(--tg-hint);
    }

    .toast-wrap{
      position:fixed;
      left:0;right:0;
      bottom:calc(var(--safe-bottom)+10px);
      display:flex;
      justify-content:center;
      pointer-events:none;
      padding:0 12px;
      z-index:40;
    }
    .toast{
      pointer-events:auto;
      max-width:900px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.95);
      padding:8px 12px;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      opacity:0;
      transform:translateY(10px);
      transition:opacity var(--anim) var(--ease),transform var(--anim) var(--ease);
    }
    .toast.show{opacity:1;transform:translateY(0);}
    .pill{
      width:8px;height:8px;border-radius:999px;
      background:var(--tg-accent);
    }
    .pill.err{background:#f97373;}
    .pill.warn{background:#eab308;}

    .footer{
      text-align:center;
      font-size:10px;
      color:var(--tg-hint);
      margin-top:4px;
      opacity:.7;
    }

    @keyframes fadeUp{
      from{opacity:0;transform:translateY(6px);}
      to{opacity:1;transform:translateY(0);}
    }
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1);}
      50%{opacity:.55;transform:scale(.94);}
    }
    @keyframes ripple{
      to{transform:scale(16);opacity:0;}
    }
    @keyframes shimmer{
      to{transform:translateX(100%);}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <span><span class="dot"></span>ШИФРОТЕКС</span>
    <span id="runtime">Готово</span>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="msg">Сообщение</button>
    <button class="tab" data-tab="enc">Шифр</button>
    <button class="tab" data-tab="dec">Дешифр</button>
    <button class="tab" data-tab="log">Журнал</button>
  </div>

  <!-- Вкладка: Сообщение (авто-расшифровка пароля и текста) -->
  <section class="section active" id="sec-msg">
    <div class="grid">
      <div class="card">
        <div class="title">
          <span>Вход</span>
        </div>
        <label for="bundleIn">Сообщение</label>
        <textarea id="bundleIn" placeholder="Вставьте сообщение с двумя строками:
пароль: ...
текст: ..."></textarea>
        <label for="masterPass">Мастер-пароль</label>
        <input id="masterPass" type="password" placeholder="Пароль, которым шифровали пароль" />
        <div class="switch">
          <input id="showMaster" type="checkbox">
          <span>Показать</span>
        </div>
        <div class="btns">
          <button class="btn" id="btnBundle">Расшифровать</button>
        </div>
      </div>
      <div class="card">
        <div class="title">
          <span>Результат</span>
        </div>
        <label>Открытый текст</label>
        <div class="out" id="bundleOut"></div>
      </div>
    </div>
  </section>

  <!-- Вкладка: обычное шифрование -->
  <section class="section" id="sec-enc">
    <div class="grid">
      <div class="card">
        <div class="title"><span>Вход</span></div>
        <label for="pt">Текст</label>
        <textarea id="pt" placeholder="Введите текст..."></textarea>
        <div class="row">
          <div>
            <label for="encAlgo">Алгоритм</label>
            <select id="encAlgo">
              <option value="aes256">AES-256-GCM</option>
              <option value="aes192">AES-192-GCM</option>
              <option value="aes128">AES-128-GCM</option>
            </select>
          </div>
          <div>
            <label for="encPass">Пароль</label>
            <input id="encPass" type="password" placeholder="Пароль" />
          </div>
        </div>
        <div class="switch">
          <input id="showEnc" type="checkbox"><span>Показать</span>
        </div>
        <div class="btns">
          <button class="btn" id="btnGenPass">Пароль</button>
          <button class="btn secondary" id="btnCopyPass">Копия</button>
        </div>
      </div>
      <div class="card">
        <div class="title">
          <span>Шифр</span>
          <span class="meta" id="encMeta">0</span>
        </div>
        <div class="out" id="ctOut"></div>
        <div class="btns">
          <button class="btn" id="btnEncrypt">Шифровать</button>
          <button class="btn secondary" id="btnCopyCT">Копия</button>
          <button class="btn secondary" id="btnSaveCT">Файл</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Вкладка: обычное дешифрование -->
  <section class="section" id="sec-dec">
    <div class="grid">
      <div class="card">
        <div class="title"><span>Вход</span></div>
        <label for="ct">Шифр</label>
        <textarea id="ct" placeholder="Вставьте Base64..."></textarea>
        <label for="decPass">Пароль</label>
        <input id="decPass" type="password" placeholder="Пароль" />
        <div class="switch">
          <input id="showDec" type="checkbox"><span>Показать</span>
        </div>
        <div class="btns">
          <button class="btn" id="btnDecrypt">Дешифровать</button>
        </div>
      </div>
      <div class="card">
        <div class="title">
          <span>Текст</span>
          <span class="meta" id="decMeta">0</span>
        </div>
        <div class="out" id="ptOut"></div>
        <div class="btns">
          <button class="btn secondary" id="btnCopyPT">Копия</button>
          <button class="btn secondary" id="btnSavePT">Файл</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Вкладка: журнал -->
  <section class="section" id="sec-log">
    <div class="card">
      <div class="title">
        <span>Журнал</span>
        <span class="meta" id="logMeta">0</span>
      </div>
      <div class="out" id="logOut" style="min-height:200px;"></div>
      <div class="btns">
        <button class="btn secondary" id="btnExportLog">Экспорт</button>
        <button class="btn secondary" id="btnClearLog">Очистить</button>
      </div>
    </div>
  </section>

  <div class="footer">Локальное шифрование AES‑GCM. Данные не покидают браузер.</div>
</div>

<div class="toast-wrap">
  <div class="toast" id="toast">
    <div class="pill" id="toastPill"></div>
    <div id="toastText"></div>
  </div>
</div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  if (tg) {
    try{tg.ready();tg.expand();}catch(e){}
  }

  const $ = id => document.getElementById(id);

  const runtime = $('runtime');
  const toastEl = $('toast'), toastPill = $('toastPill'), toastText = $('toastText');
  let toastTimer = null;
  function toast(kind,text){
    toastText.textContent = text;
    toastPill.className = 'pill' + (kind==='error'?' err':kind==='warn'?' warn':'');
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'),2000);
  }

  function ripple(e){
    const btn = e.currentTarget;
    const rect = btn.getBoundingClientRect();
    const x = (e.clientX ?? rect.left+rect.width/2) - rect.left;
    const y = (e.clientY ?? rect.top+rect.height/2) - rect.top;
    const s = document.createElement('span');
    s.className='ripple';
    s.style.left=x+'px';
    s.style.top=y+'px';
    s.style.width='12px';
    s.style.height='12px';
    btn.appendChild(s);
    setTimeout(()=>s.remove(),500);
  }
  document.querySelectorAll('button').forEach(b=>b.addEventListener('pointerdown',ripple,{passive:true}));

  const log = [];
  function addLog(op,status,info=''){
    log.push({t:new Date().toLocaleString('ru-RU'),op,status,info});
    if(log.length>300)log.shift();
    renderLog();
  }
  function renderLog(){
    $('logMeta').textContent=log.length;
    $('logOut').textContent=log.slice().reverse().map(x=>`[${x.t}] ${x.op} [${x.status}]${x.info?' — '+x.info:''}`).join('\n')||'Пусто';
  }

  function setLoading(el,on){
    el.classList.toggle('loading',!!on);
  }

  function u8ToB64(u8){
    let s='';for(let i=0;i<u8.length;i++)s+=String.fromCharCode(u8[i]);return btoa(s);
  }
  function b64ToU8(b64){
    const bin=atob(b64.trim());const u8=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);
    return u8;
  }
  async function sha256Bytes(str){
    const enc=new TextEncoder().encode(str);
    const h=await crypto.subtle.digest('SHA-256',enc);
    return new Uint8Array(h);
  }
  async function deriveKeyBytes(pass,algo){
    const h=await sha256Bytes(pass);
    const len=algo==='aes256'?32:algo==='aes192'?24:16;
    return h.slice(0,len);
  }

  async function copyText(text){
    if(!text){toast('warn','Пусто');return;}
    try{await navigator.clipboard.writeText(text);toast('ok','Скопировано');}
    catch(e){toast('error','Нет доступа к буферу');}
  }
  function saveText(text,name){
    if(!text){toast('warn','Пусто');return;}
    const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
    toast('ok','Файл сохранён');
  }

  // Tabs
  const tabs=document.querySelectorAll('.tab');
  const sections={
    msg:$('sec-msg'),
    enc:$('sec-enc'),
    dec:$('sec-dec'),
    log:$('sec-log')
  };
  tabs.forEach(b=>b.addEventListener('click',()=>{
    const t=b.dataset.tab;
    tabs.forEach(x=>x.classList.toggle('active',x===b));
    Object.entries(sections).forEach(([k,el])=>el.classList.toggle('active',k===t));
    addLog('TAB','OK',t);
  }));

  // Show/hide
  $('showEnc').addEventListener('change',e=>$('encPass').type=e.target.checked?'text':'password');
  $('showDec').addEventListener('change',e=>$('decPass').type=e.target.checked?'text':'password');
  $('showMaster').addEventListener('change',e=>$('masterPass').type=e.target.checked?'text':'password');

  // Password/keys
  function genPassword(len=32){
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=';
    const rnd=new Uint32Array(len);crypto.getRandomValues(rnd);
    let p='';for(let i=0;i<len;i++)p+=chars[rnd[i]%chars.length];
    return p;
  }
  $('btnGenPass').addEventListener('click',()=>{
    $('encPass').value=genPassword(32);
    toast('ok','Пароль');
    addLog('PWD','OK','32');
  });
  $('btnCopyPass').addEventListener('click',()=>copyText($('encPass').value));

  // Encrypt
  $('btnEncrypt').addEventListener('click',async()=>{
    const pt=$('pt').value;
    const pass=$('encPass').value;
    const algo=$('encAlgo').value;
    if(!pt.trim()){toast('warn','Нет текста');return;}
    if(!pass||pass.length<8){toast('warn','Пароль < 8');return;}

    const out=$('ctOut');
    setLoading(out,true);runtime.textContent='Шифрование...';
    try{
      const keyBytes=await deriveKeyBytes(pass,algo);
      const iv=crypto.getRandomValues(new Uint8Array(12));
      const key=await crypto.subtle.importKey('raw',keyBytes,'AES-GCM',false,['encrypt']);
      const data=new TextEncoder().encode(pt);
      const enc=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,data);
      const encU8=new Uint8Array(enc);
      const combined=new Uint8Array(iv.length+encU8.length);
      combined.set(iv,0);combined.set(encU8,iv.length);
      const b64=u8ToB64(combined);
      out.textContent=b64;
      $('encMeta').textContent=b64.length;
      toast('ok','Готово');
      addLog('ENC','OK',algo);
    }catch(e){
      out.textContent='';
      toast('error','Ошибка шифрования');
      addLog('ENC','ERR',e.message||'err');
    }finally{
      setLoading(out,false);runtime.textContent='Готово';
    }
  });
  $('btnCopyCT').addEventListener('click',()=>copyText($('ctOut').textContent.trim()));
  $('btnSaveCT').addEventListener('click',()=>saveText($('ctOut').textContent.trim(),'encrypted.txt'));

  // Decrypt
  $('btnDecrypt').addEventListener('click',async()=>{
    const b64=$('ct').value.trim();
    const pass=$('decPass').value;
    const out=$('ptOut');
    if(!b64){toast('warn','Нет данных');return;}
    if(!pass){toast('warn','Нет пароля');return;}

    setLoading(out,true);runtime.textContent='Дешифрование...';
    try{
      const combined=b64ToU8(b64);
      if(combined.length<13)throw new Error('short');
      const iv=combined.slice(0,12);
      const enc=combined.slice(12);
      const algos=['aes256','aes192','aes128'];
      let ok=false;
      for(const algo of algos){
        try{
          const keyBytes=await deriveKeyBytes(pass,algo);
          const key=await crypto.subtle.importKey('raw',keyBytes,'AES-GCM',false,['decrypt']);
          const buf=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,enc);
          const txt=new TextDecoder().decode(buf);
          out.textContent=txt;
          $('decMeta').textContent=txt.length;
          ok=true;
          addLog('DEC','OK',algo);
          break;
        }catch(_e){}
      }
      if(!ok)throw new Error('bad');
      toast('ok','Готово');
    }catch(e){
      out.textContent='';
      $('decMeta').textContent='0';
      toast('error','Ошибка');
      addLog('DEC','ERR',e.message||'err');
    }finally{
      setLoading(out,false);runtime.textContent='Готово';
    }
  });
  $('btnCopyPT').addEventListener('click',()=>copyText($('ptOut').textContent.trim()));
  $('btnSavePT').addEventListener('click',()=>saveText($('ptOut').textContent.trim(),'decrypted.txt'));

  // Bundle tab: message -> decrypt password -> decrypt text
  $('btnBundle').addEventListener('click',async()=>{
    const msg=$('bundleIn').value.trim();
    const master=$('masterPass').value;
    const out=$('bundleOut');
    if(!msg){toast('warn','Нет сообщения');return;}
    if(!master){toast('warn','Нет пароля');return;}

    // формат:
    // пароль: <base64>
    // текст: <base64>
    const lines=msg.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    let encPwd='',encTxt='';
    for(const l of lines){
      if(l.toLowerCase().startsWith('пароль:')) encPwd=l.split(':').slice(1).join(':').trim();
      else if(l.toLowerCase().startsWith('текст:')) encTxt=l.split(':').slice(1).join(':').trim();
    }
    if(!encPwd || !encTxt){toast('warn','Неверный формат');return;}

    setLoading(out,true);runtime.textContent='Авто‑расшифровка...';
    try{
      const combinedPwd=b64ToU8(encPwd);
      const ivPwd=combinedPwd.slice(0,12);
      const encPwdData=combinedPwd.slice(12);
      const keyBytes=await deriveKeyBytes(master,'aes256');
      const key=await crypto.subtle.importKey('raw',keyBytes,'AES-GCM',false,['decrypt']);
      const pwdBuf=await crypto.subtle.decrypt({name:'AES-GCM',iv:ivPwd},key,encPwdData);
      const realPwd=new TextDecoder().decode(pwdBuf); // пароль для текста

      const combinedTxt=b64ToU8(encTxt);
      const ivTxt=combinedTxt.slice(0,12);
      const encTxtData=combinedTxt.slice(12);
      const key2=await crypto.subtle.importKey('raw',(await deriveKeyBytes(realPwd,'aes256')),'AES-GCM',false,['decrypt']);
      const txtBuf=await crypto.subtle.decrypt({name:'AES-GCM',iv:ivTxt},key2,encTxtData);
      const txt=new TextDecoder().decode(txtBuf);
      out.textContent=txt;
      addLog('BUNDLE','OK','пароль+текст');
      toast('ok','Готово');
    }catch(e){
      out.textContent='';
      toast('error','Ошибка сообщения');
      addLog('BUNDLE','ERR',e.message||'err');
    }finally{
      setLoading(out,false);runtime.textContent='Готово';
    }
  });

  // Log control
  $('btnExportLog').addEventListener('click',()=>{
    const text=log.map(x=>`[${x.t}] ${x.op} [${x.status}]${x.info?' — '+x.info:''}`).join('\n')||'Пусто';
    saveText(text,'log.txt');
  });
  $('btnClearLog').addEventListener('click',()=>{
    log.length=0;renderLog();toast('ok','Очищено');
  });

  addLog('INIT','OK',tg?'Telegram':'Browser');
  renderLog();
})();
</script>
</body>
</html>
